{% extends 'base.html' %}
{% block title %}Ve√≠culos{% endblock %}
{% block content %}
<style>
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .icon-button {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.45rem 0.75rem;
        border: 1px solid #d0d7de;
        background: #f7f9fb;
        color: #0f172a;
        border-radius: 6px;
        cursor: pointer;
    }
    .icon-button:hover { background: #e8edf2; }
    .vehicles-header { display: flex; flex-direction: column; gap: 0.35rem; width: 100%; align-items: stretch; justify-content: flex-start; }
    .vehicles-header .header-row { display: flex; align-items: center; gap: 0.75rem; justify-content: space-between; flex-wrap: wrap; width: 100%; }
    .vehicles-header p { margin: 0; color: var(--text-muted); font-size: 0.95rem; }

    .print-header { display: none; align-items: center; justify-content: space-between; gap: 1rem; padding: 0 0 1rem; margin-bottom: 1rem; border-bottom: 1px solid #d0d7de; }
    .print-brand { display: flex; flex-direction: column; gap: 0.15rem; }
    .print-title { margin: 0; font-size: 1.1rem; font-weight: 700; color: #0f172a; }
    .print-subtitle { margin: 0; font-size: 0.95rem; color: #475569; }
    .print-logo img { height: 42px; }
    @media print {
        body, .card, .table-wrapper, table, th, td { background: #fff !important; color: #000 !important; }
        .no-print, nav, header.site-header, .app-header, .search-container, .btn-icon, .modal { display: none !important; }
        .print-header { display: flex; }
        .print-title, .print-subtitle { color: #000; }
        .section-header { display: block; }
        .vehicles-table { width: 100%; table-layout: fixed; }
        .vehicles-table th,
        .vehicles-table td {
            padding: 8px 6px;
            font-size: 0.85rem;
            word-break: break-word;
            white-space: normal;
        }
        .vehicles-table th { font-size: 0.82rem; }
        .actions-col, .actions-cell { display: none !important; }
    }
</style>

<section class="card no-print">
    <header class="section-header">
        <h2>Novo ve√≠culo</h2>
    </header>
    <form method="post" enctype="multipart/form-data" class="form-grid vehicle-form">
        <label class="field-placa">
            <span>Placa</span>
            <input type="text" name="placa" required>
        </label>
        <label class="field-marca">
            <span>Marca</span>
            <select name="marca" id="vehicleBrand" required>
                <option value="">Marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca.label }}">{{ marca.label }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="field-modelo">
            <span>Modelo</span>
            <select name="modelo" id="vehicleModel" required disabled>
                <option value="">Selecione a marca primeiro</option>
            </select>
        </label>
        <label class="field-tipo">
            <span>Tipo</span>
            <input type="text" id="vehicleTypeLabel" class="readonly-input" placeholder="Selecione um modelo" readonly>
            <input type="hidden" name="tipo" id="vehicleTypeValue">
        </label>
        <!-- DROPDOWN: Combust√≠vel -->
        <label>
            <span>Combust√≠vel</span>
            <select name="combustivel" required>
                <option value="">Combust√≠vel</option>
                {% for combustivel in combustiveis %}
                    <option value="{{ combustivel.id }}">{{ combustivel.label }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="full-row">
            <span>Foto</span>
            <input type="file" name="foto_veiculo" accept="image/*" required>
        </label>
        <button type="submit" class="btn btn-primary">Cadastrar</button>
    </form>
    <script>
        document.querySelector('.vehicle-form').addEventListener('submit', (event) => {
            const tipoValue = document.getElementById('vehicleTypeValue').value;
            if (!tipoValue) {
                event.preventDefault();
                alert('Selecione um modelo para definir o tipo do ve√≠culo.');
            }
        });
    </script>
</section>

<section class="card">
    <div class="print-header">
        <div class="print-brand">
            <p class="print-title">Trivia Km</p>
            <p class="print-subtitle">Ve√≠culos cadastrados</p>
        </div>
        <div class="print-logo">
            <img src="{{ url_for('serve_public_asset', filename='logo.png') }}" alt="Logo Trivia">
        </div>
    </div>
    <header class="section-header vehicles-header">
        <div class="header-row">
            <h2>Ve√≠culos cadastrados</h2>
            <button id="print-veiculos" class="icon-button no-print" type="button" aria-label="Imprimir PDF">
                <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9V2h12v7" />
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                    <path d="M6 14h12v8H6z" />
                </svg>
                <span>Imprimir</span>
            </button>
        </div>
        <p>Gerencie a frota cadastrada com busca r√°pida pela placa.</p>
    </header>

    <div class="search-container">
        <input 
            type="text"
            id="veiculosSearch"
            class="search-input"
            placeholder="Pesquisar por placa..."
        >
    </div>

    {% if veiculos %}
        <div class="table-wrapper">
            <table class="vehicles-table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Modelo</th>
                        <th>Marca</th>
                        <th>Tipo</th>
                        <th>Combust√≠vel</th>
                        <th>Empresa</th>
                        <th>√Årea</th>
                        <th>KM rodado</th>
                        <th>Criado em</th>
                        <th class="actions-col">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for veiculo in veiculos %}
                        {% set created_raw = veiculo.created_at %}
                        {% set formatted_date = 'N/A' %}
                        {% if created_raw %}
                            {% set date_part = created_raw.split('T')[0] if 'T' in created_raw else created_raw %}
                            {% set time_part = created_raw.split('T')[1][:5] if 'T' in created_raw else '' %}
                            {% set parts = date_part.split('-') %}
                            {% if parts|length == 3 %}
                                {% set formatted_date = parts[2] ~ '/' ~ parts[1] ~ '/' ~ parts[0][2:] %}
                            {% else %}
                                {% set formatted_date = date_part %}
                            {% endif %}
                            {% if time_part %}
                                {% set formatted_date = formatted_date ~ ' - ' ~ time_part %}
                            {% endif %}
                        {% endif %}
                        <tr class="vehicle-row" data-foto-url="{{ veiculo.foto_url or '' }}" data-placa="{{ veiculo.placa }}" style="cursor: pointer;">
                            <td>{{ veiculo.placa }}</td>
                            <td>{{ veiculo.modelo }}</td>
                            <td>{{ veiculo.marca or '-' }}</td>
                            <td>{{ veiculo.tipo_label }}</td>
                            <td>{{ veiculo.combustivel_label }}</td>
                            <td>{{ veiculo.empresa or '-' }}</td>
                            <td>{{ veiculo.area or '-' }}</td>
                            <td>{{ (veiculo.km_rodado or 0)|int }} km</td>
                            <td>{{ formatted_date }}</td>
                            <td class="actions-cell">
                                <button
                                    type="button"
                                    class="btn-icon btn-vehicle-edit"
                                    title="Editar ve√≠culo"
                                    data-veiculo-id="{{ veiculo.id }}"
                                    data-placa="{{ veiculo.placa }}"
                                    data-modelo="{{ veiculo.modelo }}"
                                    data-marca="{{ veiculo.marca }}"
                                    data-tipo="{{ veiculo.tipo }}"
                                    data-combustivel="{{ veiculo.combustivel }}"
                                    data-empresa="{{ veiculo.empresa or '' }}"
                                    data-area="{{ veiculo.area or '' }}"
                                >‚úèÔ∏è</button>
                                <button
                                    type="button"
                                    class="btn-icon btn-vehicle-delete"
                                    title="Excluir ve√≠culo"
                                    data-veiculo-id="{{ veiculo.id }}"
                                    data-placa="{{ veiculo.placa }}"
                                >üóëÔ∏è</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-state">Nenhum ve√≠culo cadastrado at√© o momento.</p>
    {% endif %}
</section>

<!-- Modal de edi√ß√£o -->
<div id="vehicleEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Editar ve√≠culo</h3>
            <button class="modal-close" data-dismiss="modal">&times;</button>
        </div>
        <form id="vehicleEditForm" class="modal-form">
            <input type="hidden" id="editVehicleId">

            <label>
                <span>Placa</span>
                <input type="text" id="editVehiclePlaca" required>
            </label>
            <label>
                <span>Marca</span>
                <select id="editVehicleMarca" required>
                    <option value="">Selecione a marca...</option>
                    {% for marca in marcas %}
                        <option value="{{ marca.label }}">{{ marca.label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>Modelo</span>
                <select id="editVehicleModelo" required disabled>
                    <option value="">Selecione a marca primeiro...</option>
                </select>
            </label>
            <label>
                <span>Tipo</span>
                <input type="text" id="editVehicleTipoLabel" class="readonly-input" placeholder="Selecione um modelo" readonly>
                <input type="hidden" id="editVehicleTipoValue">
            </label>
            <label>
                <span>Combust√≠vel</span>
                <select id="editVehicleCombustivel" required>
                    <option value="">Selecione o combust√≠vel...</option>
                    {% for combustivel in combustiveis %}
                        <option value="{{ combustivel.id }}">{{ combustivel.label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>Empresa</span>
                <input type="text" id="editVehicleEmpresa" placeholder="Empresa (opcional)" readonly style="background: #f0f0f0;">
            </label>
            <label>
                <span>√Årea</span>
                <input type="text" id="editVehicleArea" placeholder="√Årea (opcional)" readonly style="background: #f0f0f0;">
            </label>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar altera√ß√µes</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de exclus√£o -->
<div id="vehicleDeleteModal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Excluir ve√≠culo</h3>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja excluir o ve√≠culo <strong id="deleteVehicleLabel"></strong>?</p>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">Esta a√ß√£o n√£o pode ser desfeita.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmVehicleDelete">Excluir ve√≠culo</button>
        </div>
    </div>
</div>

<!-- Modal de visualiza√ß√£o de foto -->
<div id="vehiclePhotoModal" class="modal">
    <div class="modal-content modal-photo">
        <div class="modal-header">
            <h3 id="photoModalTitle">Foto do ve√≠culo</h3>
            <button class="modal-close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <img id="photoModalImage" src="" alt="Foto do ve√≠culo" style="max-width: 100%; max-height: 500px; object-fit: contain;">
        </div>
        <div style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 8px; margin-top: 8px;">
            <p id="photoModalPlaca"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// @ts-nocheck - Jinja2 template syntax
const VEHICLE_BRANDS = {{ marcas | tojson }};
const VEHICLE_TYPES = {{ tipos | tojson }};
const TYPE_LOOKUP = VEHICLE_TYPES.reduce((acc, tipo) => {
    acc[tipo.id] = tipo.label;
    return acc;
}, {});

function findBrandByValue(value) {
    if (!value) return undefined;
    const normalized = value.toLowerCase();
    return VEHICLE_BRANDS.find(brand => brand.label.toLowerCase() === normalized || brand.id === normalized);
}

function setupBrandModelType({ brandSelect, modelSelect, typeLabelInput, typeValueInput }) {
    if (!brandSelect || !modelSelect) return null;
    const placeholderDefault = 'Selecione a marca primeiro...';

    function updateType(option) {
        if (option && option.dataset) {
            const tipoId = option.dataset.tipoId || '';
            if (typeValueInput) typeValueInput.value = tipoId;
            if (typeLabelInput) typeLabelInput.value = TYPE_LOOKUP[tipoId] || '';
        } else {
            if (typeValueInput) typeValueInput.value = '';
            if (typeLabelInput) typeLabelInput.value = '';
        }
    }

    function selectOptionByValue(selectElement, value) {
        if (!value) {
            selectElement.value = '';
            return;
        }
        const normalized = value.toLowerCase();
        const match = Array.from(selectElement.options).find(opt => opt.value.toLowerCase() === normalized);
        if (match) {
            selectElement.value = match.value;
        } else {
            selectElement.value = '';
        }
    }

    function resetModels(message = placeholderDefault) {
        modelSelect.innerHTML = `<option value="">${message}</option>`;
        modelSelect.disabled = true;
        updateType();
    }

    function populateModels(brandLabel, selectedModelLabel) {
        if (brandLabel !== undefined) {
            selectOptionByValue(brandSelect, brandLabel);
        }

        const brand = findBrandByValue(brandSelect.value);
        resetModels(brand ? 'Selecione o modelo...' : placeholderDefault);

        if (!brand) return;

        brand.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.label;
            option.textContent = model.label;
            option.dataset.modelId = model.id;
            option.dataset.tipoId = model.tipo_id;
            modelSelect.appendChild(option);
        });

        modelSelect.disabled = false;
        if (selectedModelLabel !== undefined) {
            selectOptionByValue(modelSelect, selectedModelLabel);
        } else {
            modelSelect.value = '';
        }
        updateType(modelSelect.selectedOptions[0]);
    }

    brandSelect.addEventListener('change', () => {
        populateModels(brandSelect.value, '');
    });

    modelSelect.addEventListener('change', () => {
        updateType(modelSelect.selectedOptions[0]);
    });

    resetModels();

    return {
        populate: populateModels,
    };
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', () => {
        const modal = btn.closest('.modal');
        if (modal) closeModal(modal.id);
    });
});

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal(modal.id);
    });
});

const vehiclesTable = document.querySelector('.vehicles-table');
const vehicleRows = vehiclesTable ? vehiclesTable.querySelectorAll('tbody tr') : [];
const vehicleSearch = document.getElementById('veiculosSearch');

if (vehicleSearch && vehicleRows.length) {
    vehicleSearch.addEventListener('input', (event) => {
        const term = event.target.value.toLowerCase().trim();
        vehicleRows.forEach(row => {
            const placa = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            row.style.display = !term || placa.includes(term) ? '' : 'none';
        });
    });
}

const createBrandController = setupBrandModelType({
    brandSelect: document.getElementById('vehicleBrand'),
    modelSelect: document.getElementById('vehicleModel'),
    typeLabelInput: document.getElementById('vehicleTypeLabel'),
    typeValueInput: document.getElementById('vehicleTypeValue'),
});

const editBrandController = setupBrandModelType({
    brandSelect: document.getElementById('editVehicleMarca'),
    modelSelect: document.getElementById('editVehicleModelo'),
    typeLabelInput: document.getElementById('editVehicleTipoLabel'),
    typeValueInput: document.getElementById('editVehicleTipoValue'),
});

document.querySelectorAll('.btn-vehicle-edit').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('editVehicleId').value = btn.dataset.veiculoId;
        document.getElementById('editVehiclePlaca').value = btn.dataset.placa || '';
        document.getElementById('editVehicleCombustivel').value = btn.dataset.combustivel || '';
        document.getElementById('editVehicleEmpresa').value = btn.dataset.empresa || '';
        document.getElementById('editVehicleArea').value = btn.dataset.area || '';
        if (editBrandController) {
            editBrandController.populate(btn.dataset.marca || '', btn.dataset.modelo || '');
            const editMarcaSelect = document.getElementById('editVehicleMarca');
            if (!editMarcaSelect.value) {
                const fallbackTipo = btn.dataset.tipo || '';
                const tipoLabel = TYPE_LOOKUP[fallbackTipo] || fallbackTipo;
                document.getElementById('editVehicleTipoLabel').value = tipoLabel;
                document.getElementById('editVehicleTipoValue').value = fallbackTipo;
                const editModeloSelect = document.getElementById('editVehicleModelo');
                editModeloSelect.innerHTML = '<option value="">Selecione a marca primeiro...</option>';
                editModeloSelect.disabled = true;
                editModeloSelect.value = btn.dataset.modelo || '';
            }
        }
        openModal('vehicleEditModal');
    });
});

const vehicleEditForm = document.getElementById('vehicleEditForm');
if (vehicleEditForm) {
    vehicleEditForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const vehicleId = document.getElementById('editVehicleId').value;
        const payload = {
            placa: document.getElementById('editVehiclePlaca').value.trim().toUpperCase(),
            modelo: document.getElementById('editVehicleModelo').value.trim(),
            marca: document.getElementById('editVehicleMarca').value.trim(),
            tipo: document.getElementById('editVehicleTipoValue').value,
            combustivel: document.getElementById('editVehicleCombustivel').value,
            empresa: document.getElementById('editVehicleEmpresa').value.trim(),
            area: document.getElementById('editVehicleArea').value.trim(),
        };

        if (!payload.tipo) {
            alert('Selecione um modelo v√°lido para definir o tipo.');
            return;
        }

        try {
            const response = await fetch(`/admin/veiculos/${vehicleId}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao atualizar ve√≠culo.');
            }
        } catch (error) {
            console.error(error);
            alert('Erro ao atualizar ve√≠culo.');
        }
    });
}

let vehicleIdToDelete = null;

// Clique na linha da tabela para visualizar foto
document.querySelectorAll('.vehicle-row').forEach(row => {
    row.addEventListener('click', (event) => {
        // N√£o abrir modal se clicou em um bot√£o
        if (event.target.closest('.btn-icon')) return;
        
        const fotoUrl = row.dataset.fotoUrl;
        const placa = row.dataset.placa;
        
        if (!fotoUrl) {
            alert(`Nenhuma foto cadastrada para ${placa}`);
            return;
        }
        
        document.getElementById('photoModalImage').src = fotoUrl;
        document.getElementById('photoModalPlaca').textContent = `Placa: ${placa}`;
        openModal('vehiclePhotoModal');
    });
});

document.querySelectorAll('.btn-vehicle-delete').forEach(btn => {
    btn.addEventListener('click', () => {
        vehicleIdToDelete = btn.dataset.veiculoId;
        document.getElementById('deleteVehicleLabel').textContent = btn.dataset.placa || '';
        openModal('vehicleDeleteModal');
    });
});

const confirmDeleteBtn = document.getElementById('confirmVehicleDelete');
if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', async () => {
        if (!vehicleIdToDelete) return;
        try {
            const response = await fetch(`/admin/veiculos/${vehicleIdToDelete}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao excluir ve√≠culo.');
            }
        } catch (error) {
            console.error(error);
            alert('Erro ao excluir ve√≠culo.');
        } finally {
            closeModal('vehicleDeleteModal');
            vehicleIdToDelete = null;
        }
    });
}

// Bot√£o de imprimir ve√≠culos
document.getElementById('print-veiculos')?.addEventListener('click', () => {
    window.print();
});
</script>
{% endblock %}
