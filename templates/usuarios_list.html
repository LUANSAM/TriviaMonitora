{% extends 'base.html' %}
{% block title %}Usu√°rios{% endblock %}
{% block content %}
<section class="card">
    <header class="section-header">
        <h2>Usu√°rios cadastrados</h2>
    </header>
    <div class="search-container">
        <input 
            type="text" 
            id="usuariosSearch" 
            class="search-input" 
            placeholder="Pesquisar por nome..."
        >
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th class="email-column">E-mail</th>
                    <th>Posto</th>
                    <th>Autorizado</th>
                    <th class="created-column">Criado em</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                    {% set created_date = usuario.created_at %}
                    {% set formatted_date = created_date[:10] | replace('-', '/') if created_date else 'N/A' %}
                    {% if created_date and 'T' in created_date %}
                        {% set time_part = created_date.split('T')[1][:5] if 'T' in created_date else '' %}
                        {% set formatted_date = created_date[:10] | replace('-', '/') ~ ' - ' ~ time_part %}
                    {% endif %}
                    <tr>
                        <td>{{ usuario.nome }}</td>
                        <td class="email-column">{{ usuario.email }}</td>
                        <td>
                            <div>{{ usuario.area }}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 2px;">{{ usuario.empresa }}</div>
                        </td>
                        <td>
                            <select class="user-status-select" data-user-id="{{ usuario.id }}" data-current="{{ usuario.autorizado | lower }}">
                                <option value="true" {% if usuario.autorizado %}selected{% endif %}>Sim</option>
                                <option value="false" {% if not usuario.autorizado %}selected{% endif %}>N√£o</option>
                            </select>
                        </td>
                        <td class="created-column">{{ formatted_date }}</td>
                        <td class="actions-cell">
                            <button class="btn-icon btn-edit" title="Editar usu√°rio" data-user-id="{{ usuario.id }}" data-nome="{{ usuario.nome }}" data-empresa="{{ usuario.empresa }}" data-area="{{ usuario.area }}" data-role="{{ usuario.role }}">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon btn-delete" title="Excluir usu√°rio" data-user-id="{{ usuario.id }}" data-nome="{{ usuario.nome }}">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Modal de Edi√ß√£o de Usu√°rio -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Editar usu√°rio</h3>
            <button class="modal-close" data-dismiss="modal">&times;</button>
        </div>
        <form id="editForm" class="modal-form">
            <input type="hidden" id="editUserId" name="user_id">
            
            <label>
                <span>Nome</span>
                <input type="text" id="editNome" name="nome" required>
            </label>
            
            {% if current_user and current_user.email == 'luan.sampaio@triviatrens.com.br' %}
            <label>
                <span>Empresa</span>
                <select id="editEmpresa" name="empresa" required>
                    <option value="">Selecione a empresa...</option>
                    <option value="Trivia Trens">Trivia Trens</option>
                    <option value="Tic Trens">Tic Trens</option>
                    <option value="metro_bh">Metr√¥ BH</option>
                </select>
            </label>
            
            <label>
                <span>√Årea</span>
                <select id="editArea" name="area" required>
                    <option value="">Selecione a √°rea...</option>
                    <option value="Restabelecimento">Restabelecimento</option>
                    <option value="Energia">Energia</option>
                    <option value="Sinaliza√ß√£o">Sinaliza√ß√£o</option>
                    <option value="Telecom">Telecom</option>
                    <option value="Engenharia">Engenharia</option>
                    <option value="Civil/VP">Civil/VP</option>
                    <option value="Oficinas">Oficinas</option>
                    <option value="MRO">MRO</option>
                </select>
            </label>

            <label>
                <span>Perfil</span>
                <select id="editRole" name="role">
                    <option value="user">Usu√°rio</option>
                    <option value="admin">Admin</option>
                </select>
            </label>
            {% endif %}
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar altera√ß√µes</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Confirmar exclus√£o</h3>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja excluir o usu√°rio <strong id="deleteUsername"></strong>?</p>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">Esta a√ß√£o n√£o pode ser desfeita.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir usu√°rio</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
    @media (max-width: 550px) {
        .email-column {
            display: none !important;
        }
        .created-column {
            display: none !important;
        }
        
        /* Reduz o tamanho da fonte dos t√≠tulos das colunas */
        table thead th {
            font-size: 0.75rem !important;
            padding: 8px 4px !important;
        }
        
        /* Reduz o espa√ßamento entre os √≠cones de a√ß√£o */
        .actions-cell {
            padding: 4px !important;
        }
        
        .actions-cell .btn-icon {
            margin: 0 2px !important;
            padding: 4px !important;
            font-size: 1rem !important;
        }
        
        /* Ajusta as c√©lulas da tabela */
        table tbody td {
            padding: 8px 4px !important;
            font-size: 0.85rem !important;
        }
    }
    
    @media (max-width: 500px) {
        /* Melhora distribui√ß√£o de colunas em telas muito pequenas */
        table thead th:last-child {
            text-align: right !important;
            white-space: nowrap !important;
            width: 1% !important;
        }
        
        td.actions-cell {
            text-align: right !important;
            white-space: nowrap !important;
            width: 1% !important;
            padding-right: 2px !important;
        }
        
        .actions-cell .btn-icon {
            margin: 0 1px !important;
            padding: 2px !important;
            font-size: 0.95rem !important;
        }

        /* Evita quebra de linha na coluna Posto e mant√©m rolagem horizontal */
        .table-wrapper {
            overflow-x: auto !important;
        }
        table th:nth-child(3),
        table td:nth-child(3) {
            white-space: nowrap !important;
        }
    }
</style>
<script>
function updateSelectColor(select) {
    const isTrue = select.value === 'true';
    if (isTrue) {
        select.setAttribute('data-status', 'true');
    } else {
        select.setAttribute('data-status', 'false');
    }
}

// Gerenciamento de modais
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fechar modal ao clicar no X ou Cancelar
document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const modal = btn.closest('.modal');
        closeModal(modal.id);
    });
});

// Fechar modal ao clicar fora dele
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

// Filtro de pesquisa
const searchInput = document.getElementById('usuariosSearch');
const tableRows = document.querySelectorAll('table tbody tr');

searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    tableRows.forEach(row => {
        const nomeCell = row.querySelector('td:first-child');
        const nome = nomeCell ? nomeCell.textContent.toLowerCase() : '';
        
        if (searchTerm === '' || nome.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Inicializa cores dos dropdowns de status
document.querySelectorAll('.user-status-select').forEach(select => {
    updateSelectColor(select);
    
    select.addEventListener('change', async (e) => {
        const userId = select.dataset.userId;
        const newStatus = select.value === 'true';
        
        updateSelectColor(select);
        
        try {
            const response = await fetch(`/admin/usuarios/${userId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ autorizado: newStatus }),
            });
            
            if (!response.ok) {
                alert('Erro ao atualizar status do usu√°rio');
                select.value = select.dataset.current;
                updateSelectColor(select);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao atualizar status do usu√°rio');
            select.value = select.dataset.current;
            updateSelectColor(select);
        }
    });
});

// Bot√µes de edi√ß√£o
document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', () => {
        const userId = btn.dataset.userId;
        const nome = btn.dataset.nome;
        const empresa = btn.dataset.empresa;
        const area = btn.dataset.area;
        const role = btn.dataset.role;
        
        document.getElementById('editUserId').value = userId;
        document.getElementById('editNome').value = nome;
        const empresaField = document.getElementById('editEmpresa');
        if (empresaField) {
            empresaField.value = empresa;
        }
        const areaField = document.getElementById('editArea');
        if (areaField) {
            areaField.value = area;
        }
        const roleField = document.getElementById('editRole');
        if (roleField) {
            roleField.value = role || 'user';
        }
        
        openModal('editModal');
    });
});

// Submit do formul√°rio de edi√ß√£o
document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const nome = document.getElementById('editNome').value;
    const empresaField = document.getElementById('editEmpresa');
    const areaField = document.getElementById('editArea');
    const roleField = document.getElementById('editRole');
    const role = roleField ? roleField.value : null;
    
    try {
        const payload = { nome };
        if (empresaField) {
            payload.empresa = empresaField.value;
        }
        if (areaField) {
            payload.area = areaField.value;
        }
        if (roleField && role) {
            payload.role = role;
        }

        const response = await fetch(`/admin/usuarios/${userId}/edit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });
        
        if (response.ok) {
            alert('Usu√°rio atualizado com sucesso!');
            location.reload();
        } else {
            alert('Erro ao atualizar usu√°rio');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar usu√°rio');
    }
});

// Vari√°vel para armazenar o ID do usu√°rio a ser exclu√≠do
let userIdToDelete = null;

// Bot√µes de exclus√£o
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', () => {
        userIdToDelete = btn.dataset.userId;
        const nome = btn.dataset.nome;
        
        document.getElementById('deleteUsername').textContent = nome;
        openModal('deleteModal');
    });
});

// Confirma√ß√£o de exclus√£o
document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!userIdToDelete) return;
    
    try {
        const response = await fetch(`/admin/usuarios/${userIdToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            alert('Usu√°rio exclu√≠do com sucesso!');
            location.reload();
        } else {
            alert('Erro ao excluir usu√°rio');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir usu√°rio');
    } finally {
        closeModal('deleteModal');
        userIdToDelete = null;
    }
});
</script>
{% endblock %}
