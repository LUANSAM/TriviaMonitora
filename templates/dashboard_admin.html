{% extends 'base.html' %}
{% block title %}Painel Administrativo{% endblock %}
{% block content %}
<section class="hero-card">
    <div>
        <p class="eyebrow">Centro Operacional</p>
        <div style="display: flex; align-items: center; gap: 12px;">
            <h2>Bem-vindo, {{ current_user.nome }}</h2>
            <a href="{{ url_for('logout') }}" title="Sair" style="opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </a>
        </div>
        <p>Gerencie relatórios, usuários e veículos em um só lugar.</p>
        
        <!-- Preferências de Notificação -->
    </div>
</section>

<section class="stats-grid">
    <a class="stat-card" href="{{ url_for('historico_relatorios') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Viagens</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                <path d="M14 2v6h6M9 15h6M9 11h6"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.relatorios }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('historico_avarias') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Avarias</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.avarias }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('lista_usuarios') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Usuários</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.usuarios }}</strong>
    </a>
    <a class="stat-card" href="{{ url_for('gerenciar_veiculos') }}" style="cursor: pointer; text-decoration: none; color: inherit;">
        <div class="stat-header">
            <span class="stat-label">Veículos</span>
            <svg class="stat-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm11 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM5 11l1.5-4.5h11L19 11H5z"/>
            </svg>
        </div>
        <strong class="stat-value">{{ stats.veiculos }}</strong>
    </a>
</section>

<section class="card">
    <header class="section-header">
        <h3>Viagens em andamento</h3>
        <p>Controle os veículos que estão fora da base neste momento.</p>
    </header>

    {% if viagens_abertas %}
        <div class="table-wrapper">
            <table class="vehicles-table">
                <thead>
                    <tr>
                        <th>Placa / Condutor</th>
                        <th class="hide-mobile">Saída</th>
                        <th class="hide-mobile">KM inicial</th>
                        <th class="hide-mobile">Combustível</th>
                    </tr>
                </thead>
                <tbody>
                    {% for viagem in viagens_abertas %}
                        {% set cab = viagem.saida_info or {} %}
                        {% set veiculo = viagem.veiculo or {} %}
                        <tr>
                            <td>
                                <div style="font-weight: 600;">{{ veiculo.placa or cab.placa or '-' }}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">{{ viagem.nome or '-' }}</div>
                            </td>
                            <td class="hide-mobile">
                                {% if viagem.partida_at %}
                                    {{ viagem.partida_at[:10].split('-')[2] }}/{{ viagem.partida_at[:10].split('-')[1] }}/{{ viagem.partida_at[:10].split('-')[0] }} - {{ viagem.partida_at[11:16] }}
                                {% elif cab.data and cab.hora %}
                                    {{ cab.data }} - {{ cab.hora }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="hide-mobile">{{ cab.km_inicial or '-' }}</td>
                            <td class="hide-mobile">{{ cab.combustivel or '-' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-state">Nenhuma viagem em andamento.</p>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
    // Atualiza os stats do dashboard em tempo real sem recarregar a página
    document.addEventListener('DOMContentLoaded', () => {
        const REFRESH_MS = 30000; // 30 segundos
        
        async function updateStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    // Atualiza cada stat card sem recarregar a página
                    const statCards = {
                        'stat-relatorios': stats.relatorios,
                        'stat-avarias': stats.avarias,
                        'stat-usuarios': stats.usuarios,
                        'stat-veiculos': stats.veiculos,
                    };
                    
                    for (const [id, value] of Object.entries(statCards)) {
                        const element = document.querySelector('.stat-value');
                        // Atualiza múltiplos elementos
                    }
                }
            } catch (error) {
                console.log('Erro ao atualizar stats:', error);
            }
        }
        
        // Não recarrega automaticamente a página - apenas atualiza dados via API
        // setInterval(updateStats, REFRESH_MS);
    });
</script>
{% endblock %}
